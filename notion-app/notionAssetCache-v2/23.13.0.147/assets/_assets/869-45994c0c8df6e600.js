"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[869],{90869:(e,t,o)=>{o.r(t),o.d(t,{default:()=>We});o(57658),o(21703);var r=o(67294),n=o(83355),i=o(1302),a=o(480),s=o(86628),l=o(24405),d=o(15145),c=o(92996),p=o(61514),u=o(99036),g=o(80951),h=o(43690),y=o(1800),S=o(77657),m=o(68626),f=o(42875),P=o(47453),v=o(59753),C=o(74446),R=o(21202),b=o(3791),M=o(9291),x=o(52629),_=o(7032),k=o(37810),O=o(36610),I=o(8406),w=o(952),j=o(54642),F=o(893),T=o(47307),N=o(8055),V=o(993),L=o(13447),Z=o(61202),E=o(52275),D=o(36488),B=o(74194),A=o(68894),U=o(84076),Q=o(78140),q=o(53437),G=o(31278),K=o(76798),H=o(72495),W=o(46247),z=o(9897),Y=o(66890),$=o(23586),X=o(97978),J=o(70764),ee=o(75079),te=o(33929),oe=o(60709),re=o(70219),ne=o(65598),ie=o(18514),ae=o(77907),se=o(18245),le=o(75822),de=o(80444),ce=o(77080),pe=o(30874),ue=o(6258),ge=o(72087),he=o(88280),ye=o(51741),Se=o(30926),me=(o(30541),o(53965)),fe=o(60971),Pe=o(14473),ve=o(79131),Ce=o(68785),Re=o(32163),be=o(53336),Me=o(43145),xe=o(26388),_e=o(28463),ke=o(75203),Oe=o(73744),Ie=o(98742),we=o(34859),je=o(45452),Fe=o(29798),Te=o(59674),Ne=o(85893);class Ve extends n.Z{constructor(){super(...arguments),this.storeTypes={menuListStore:Fe.Z,draggableListStore:je.Z},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleDraggableListDrop=(e,t)=>Ae(e,t,this.stores.menuListStore,this.props.onDrag)}didUpdate(e){const{menuListStore:t}=this.stores,{device:o}=this.environment;!this.props.searchQuery||me.Xy(e.searchQuery,this.props.searchQuery)||o.isMobile||t.setState({...t.state,focus:{section:0,indexLocal:0,indexGlobal:0}})}renderComponent(){const{device:e}=this.environment;return e.isMobile?(0,Ne.jsx)(qe,{relationPropertyMenuResultsProps:this.props,menuListStore:this.stores.menuListStore,draggableListStore:this.stores.draggableListStore}):(0,Ne.jsx)(Qe,{relationPropertyMenuResultsProps:this.props,menuListStore:this.stores.menuListStore,draggableListStore:this.stores.draggableListStore})}}function Le(){return(0,Ne.jsx)("div",{style:{height:"100%",padding:ye.wI,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,Ne.jsx)(Ce.Z,{style:{margin:"0 auto"}})})}function Ze(e){const{collectionStore:t,targetCollectionStore:o,property:r,showRight:n,disabled:i,style:a}=e,l=(0,s.VK)((()=>o.isSyncedCollection()),[o]),d=(0,s.VK)((()=>{const e=t.getSchema()[r];return Boolean(e&&u.NK(e))}),[t,r]);return(0,Ne.jsx)(H.Z,{...e,noTextOverflow:!0,isTitleUppercase:!1,right:n&&!l&&!d&&(0,Ne.jsx)(ke.default,{collectionStore:t,targetCollectionStore:o,property:r,disabled:i}),style:{paddingTop:0,paddingBottom:4,...a},desktopTitleStyle:{height:19,alignItems:"center",marginTop:6,marginBottom:6,paddingLeft:12,paddingRight:9}})}Ve.displayName="RelationPropertyMenuResults",Ve.messages=(0,M.defineMessages)({noEditAccessForUnselectedRelation:{id:"collectionsRelationsPicker.noEditAccessForUnselectedRelation",defaultMessage:"Edit access required to add."},noEditAccessForSelectedRelation:{id:"collectionsRelationsPicker.noEditAccessForSelectedRelation",defaultMessage:"Edit access required to remove."}});const Ee=Ve;function De(e,t){const o=t[e];return Boolean(o&&"relation"===o.type&&1===o.limit)}function Be(e,t,o,r,n){const{disabled:i,canDrag:a,parentStore:s,collectionStore:l,targetCollectionStore:d,onAccept:p,property:u,schema:g,blockPropertyValueOverlayStore:h,onClickActionButton:y,handleClearProperty:S}=r,m=ue.G.createChildStore(s,t),f=d.getFormatStore().getKeyStore("app_config_uri").getValue()===c.p$;let P=a&&!De(u,g)&&!f;n&&(P=P&&n>1);return{key:m.id,render:r=>{const n=e.pageResult.type===ye.Rt.SelectedPage;return(0,Ne.jsx)(xe.ZP,{disableTooltip:e.canEdit,renderTooltip:()=>{const e=n?Ve.messages.noEditAccessForSelectedRelation:Ve.messages.noEditAccessForUnselectedRelation;return te.default.formatMessage(e)},render:a=>(0,Ne.jsx)(ae.LazyRelationMenuRowOld,{...r,canDrag:P&&n,collectionStore:l,targetCollectionStore:d,relatedPageStore:m,disabled:i||!e.canEdit,isSelected:n,pageStore:s,property:u,rowType:"popup",onActionButtonClick:()=>y(e.pageResult),blockPropertyValueOverlayStore:h,propertyLimit:De(u,g)?1:void 0,onOpenPageButtonClick:()=>{Pe.O([t],m,o,"relation_property")},handleClearProperty:()=>S(),...(0,Ie.Z)(r,a)}),textWrap:!0})},action:t=>{p(e.pageResult,Oe.DJ(t.event))}}}function Ae(e,t,o,r){r&&r(e),fe.sv({store:o,focus:{section:0,indexLocal:t.endPosition,indexGlobal:t.endPosition}})}function Ue(e){let{relationPropertyMenuResultsProps:t,menuListStore:o,draggableListStore:n}=e;const{results:i,onDrag:l,parentStore:d,collectionStore:p,targetCollectionStore:u,property:g,canDrag:h,canConfigureCollection:y,loading:m,onCreatePage:f,handleClearProperty:P,overlayMode:v,disabled:C,schema:R,searchQuery:b,index:x,blockPropertyValueOverlayStore:_,relationPropertyMenuStore:k,addPage:O,addingPage:I}=t,w=(0,a.O7)(),j=(0,r.useCallback)(((e,t)=>Ae(e,t,o,l)),[o,l]),{device:F}=w,T=R[g],N=Boolean("relation"===(null==T?void 0:T.type)&&T.connectedRelation),V=(0,s.VK)((()=>u.getFormat().integration_id),[u]),L=(0,r.useCallback)((e=>{let t=(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.relatedPages.subHeader",defaultMessage:"{count, plural, one {{count} linked page} other {{count} linked pages}}",values:{count:e}});return V&&([S.f3,S.mQ].includes(V)?t=(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.relatedGoogleDriveOrFigmaFiles.subHeader",defaultMessage:"{count, plural, one {{count} linked file} other {{count} linked files}}",values:{count:e}}):V===S.U9&&(t=(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.relatedGithubPages.subHeader",defaultMessage:"{count, plural, one {{count} linked PR} other {{count} linked PRs}}",values:{count:e}}))),t}),[V]),Z=(0,s.VK)((()=>u.getFormatStore().getKeyStore("app_config_uri").getValue()===c.p$),[u]),[E,D]=(0,s.VK)((()=>{const e=[],o=[],r=i.filter((e=>{let{pageResult:t}=e;return t.type===ye.Rt.SelectedPage})).length;return i.map((n=>{if(n.pageResult.type===ye.Rt.SearchPage){ue.G.createChildStore(d,n.pageResult.pointer).isTemplate()||o.push(Be(n,n.pageResult.pointer,w,t,r))}else n.pageResult.type===ye.Rt.SelectedPage&&e.push(Be(n,n.pageResult.pointer,w,t,r))})),[e,o]}),[w,i,d,t]),B=[];if(E.length>0){const e=E.map((e=>e.key.toString()));B.push({key:"results",render:t=>(0,Ne.jsx)(Ze,{...t,title:Z?void 0:De(g,R)?(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.relatedPages.limit.subHeader",defaultMessage:"Linked page"}):L(E.length),collectionStore:p,targetCollectionStore:u,property:g,showRight:"add"!==(null==v?void 0:v.type),disabled:!y,style:{paddingBottom:Z?0:4},children:h&&!De(g,R)&&e.length>1?(0,Ne.jsx)(ve.ZP,{direction:"vertical",keys:e,renderKey:o=>t.children[e.indexOf(o)],onDrop:j,store:n}):t.children}),items:E})}if(!N&&(0===D.length&&0===E.length||D.length>0)){const e=Z||m?void 0:D.length>0?E.length>0?(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.unrelatedPages.anotherPage.subHeader",defaultMessage:"Link another page"}):(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.unrelatedPages.subHeader",defaultMessage:"Link a page"}):(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.noResults.subHeader",defaultMessage:"No results"});let t;m||0!==D.length||F.isMobile||N||!b||!(Z&&D.length<1)&&Z||(D.push({key:"empty",render:e=>(0,Ne.jsx)(z.Z,{targetCollectionStore:u,title:b||"",focused:e.focused,onClick:f,isSection:!1,index:x}),action:()=>{f&&f()}}),t={paddingBottom:0}),Z&&(t={paddingBottom:0});const o={key:"unrelated",render:o=>(0,Ne.jsx)(Ze,{...o,title:e,collectionStore:p,targetCollectionStore:u,property:g,showRight:0===E.length||"add"===(null==v?void 0:v.type),disabled:!y,style:t}),items:D};"add"===(null==v?void 0:v.type)?B.unshift(o):B.push(o)}const A=[];let U;if(Z&&!F.isMobile&&E.length>0&&!C){A.push({key:"sprints_backlog",render:e=>(0,Ne.jsx)(_e.Z,{focused:e.focused,onMouseEnter:e.onMouseEnter,targetCollectionStore:u,onClick:P,isSection:!1,index:x,blockPropertyValueOverlayStore:_}),action:()=>{P&&P()}}),U={paddingBottom:0,paddingTop:0};const e={key:"backlog",render:e=>(0,Ne.jsx)(Ze,{...e,collectionStore:p,targetCollectionStore:u,property:g,showRight:0===E.length||"add"===(null==v?void 0:v.type),disabled:!y,style:U}),items:A};B.push(e)}return N?(0,Ne.jsx)(Te.c,{blockPropertyValueOverlayStore:_,collectionStore:p,targetCollectionStore:u,sections:B,propertySchema:T,property:g,pageRecordStore:d,search:b,relationPropertyMenuStore:k,addPage:O,addingPage:I}):(0,Ne.jsx)(Re.Z,{type:Re.i.Vertical,store:o,style:{padding:"4px 0px"},initialFocus:w.device.isMobile?void 0:0,sections:B})}function Qe(e){let{relationPropertyMenuResultsProps:t,menuListStore:o,draggableListStore:n}=e;const{results:i,loading:a,onScrollOffsetChange:s}=t,l=0===i.length;return(0,Ne.jsx)(r.Fragment,{children:(0,Ne.jsxs)(be.Z,{style:{width:"100%",maxHeight:300,position:"relative",...l&&{marginTop:0}},type:we.Z.Y,children:[(0,Ne.jsx)(Ue,{relationPropertyMenuResultsProps:t,menuListStore:o,draggableListStore:n}),a&&(0,Ne.jsx)(Le,{}),s&&(0,Ne.jsx)(Me.Z,{onChange:s})]})})}function qe(e){let{relationPropertyMenuResultsProps:t,menuListStore:o,draggableListStore:n}=e;const{results:i,loading:a,resultsType:s,schema:l,property:d,blockPropertyValueOverlayStore:c,collectionStore:p,targetCollectionStore:u,parentStore:g,searchQuery:h,relationPropertyMenuStore:y,addPage:S,addingPage:m}=t,f=0===i.length,P=l[d];return Boolean("relation"===(null==P?void 0:P.type)&&P.connectedRelation)&&f?(0,Ne.jsx)("div",{style:{marginTop:20},children:(0,Ne.jsx)(Te.c,{blockPropertyValueOverlayStore:c,collectionStore:p,targetCollectionStore:u,sections:[],propertySchema:P,property:d,pageRecordStore:g,search:h,relationPropertyMenuStore:y,addPage:S,addingPage:m})}):(0,Ne.jsxs)(r.Fragment,{children:[f&&!a&&"existing"===s?void 0:(0,Ne.jsx)(Ue,{relationPropertyMenuResultsProps:t,menuListStore:o,draggableListStore:n}),a&&(0,Ne.jsx)(Le,{})]})}const Ge=(0,M.defineMessages)({inputPlaceholder:{defaultMessage:"Link or create a pageâ€¦",id:"relationPropertyMenu2.searchPlaceholder"},searchLinkedInputPlaceholder:{defaultMessage:"Search linked pagesâ€¦",id:"relationPropertyMenu2.viewExisting.searchPlaceholder"},syncedCollectionInputPlaceholder:{defaultMessage:"Link a page",id:"relationPropertyMenu2.syncedCollection.searchPlaceholder"},connectedRelationInputPlaceholder:{defaultMessage:"Find a page",id:"relationPropertyMenu2.connectedRelation.searchPlaceholder"},connectedRelationGoogleDriveInputPlaceholder:{defaultMessage:"Paste in Google Drive or Google Docs link",id:"relationPropertyMenu2.connectedRelationGoogleDrive.searchPlaceholder"},connectedRelationFigmaInputPlaceholder:{defaultMessage:"Paste in https://figma.com/...",id:"relationPropertyMenu2.connectedRelationFigma.searchPlaceholder"},connectedRelationGithubInputPlaceholder:{defaultMessage:"Paste in https://github.com/...",id:"relationPropertyMenu2.connectedRelationGithub.searchPlaceholder"},sprintTypedPropertyInputAddPlaceholder:{defaultMessage:"Search...",id:"relationPropertyMenu2.sprintTypedPropertyInputAddPlaceholder.searchPlaceholder"},sprintTypedPropertyInputViewPlaceholder:{defaultMessage:"Search linked sprintsâ€¦",id:"relationPropertyMenu2.sprintTypedPropertyInputViewPlaceholder.searchPlaceholder"}});class Ke extends n.Z{constructor(){super(...arguments),this.storeTypes={store:Se.Z,requestStore:ge.Z},this.maybeOverwriteBaseUrlFromSpaceId=(0,re.b)(this.environment),this.isMemberOfSpace=this.createComputedStore((()=>{var e;return null===(e=de.default.state.currentSpaceStore)||void 0===e?void 0:e.canEdit()})),this.addPage=async e=>{const{collectionStore:t,blockPropertyValueOverlayStore:o,blockStore:r,schema:n,property:i}=this.props,a=this.getRenderState();if(!a)return;const{targetCollectionStore:s}=a,l=s.getFormat().integration_id,d=pe.Z.externalAuthentications.state.filter((e=>e.integration_id===l))[0],c=s.getFormat().pattern_name,p=pe.Z.integrations.state.find((e=>e.id===l)),{searchQuery:u}=this.stores.store.state,h=(0,ne.OY)(r)?r:void 0,y=(0,ne.OY)(r)?r.getNormalizedPropertyStore(i):void 0;this.stores.store.setState({...this.stores.store.state,addingPage:!0});try{var m,f;if(!(t&&p&&h&&y))return;const r=g.rq(y.getValue()),a=e||u||"";if(!ze({integration:p,patternName:c,url:a}))return void T.showDialog({items:[{label:(0,Ne.jsx)(M.FormattedMessage,{id:"connectedRelationPropertyMenuResults.unsupportedUrlErrorDialog.copyDebuggingInformation",defaultMessage:"Copy debugging information"}),color:"blue",onAccept:()=>{F.RD({environment:this.environment,stringValue:JSON.stringify({botId:null==d?void 0:d.parent_id,url:a},null,2),copiedMessage:F.tq.copiedToClipboard})}},{label:(0,Ne.jsx)(M.FormattedMessage,{id:"connectedRelationPropertyMenuResults.unsupportedUrlErrorDialog.closeButton",defaultMessage:"Close"}),onAccept:()=>{}}],showCancel:!1,keepFocus:!1,message:(0,Ne.jsx)(M.FormattedMessage,{id:"connectedRelationPropertyMenuResults.unsupportedUrlErrorDialog.title",defaultMessage:"This source is currently not supported. Please try a different source."})});const l=n[i],P=g.Kp(l),v=P?y.id:void 0,C=g.gg(l),x=g.ic(l),_=g.U8(l),k=g.yF(l),O=x&&ce.default.checkGate("figma_connected_relation"),N=_&&ce.default.checkGate("zendesk_connected_relation"),E=k&&ce.default.checkGate("cron_connected_relation"),D=_&&ce.default.checkGate("zendesk_ai_enabled"),B=C&&ce.default.checkGate("google_drive_connected_relation"),A=(0,J.NP)(p.id),U=(null==p?void 0:p.id)===S.U9?null===(m=A[0])||void 0===m?void 0:m.id:null==d?void 0:d.parent_id,Q=P||B||N||E||O?A.map((e=>e.id)):[U],q=await Z.yp({environment:this.environment,url:a,botIds:Q,userDefinedExternalCollectionStore:s,relatedPageId:v});if(!q)return;const G=(null===(f=he.subscriptionDataStoreInstance.state)||void 0===f?void 0:f.addOns)??[];if(D&&(0,b.de)(G)){const e=this.environment;j.getZendeskTicketConversation(e,{ticketUrl:a,spaceId:q.getSpaceId(),botId:Q[0],pageId:y.id}),X.j(e,"zendesk_unfurl_ai")}L.createAndCommit({userAction:"connectedRelationPropertyMenuResults.createRelationPage",environment:this.environment,perform:e=>{const t={id:q.id,table:R.iU,spaceId:q.getSpaceId()},n=null!=l&&l.limit?[t]:[...r,t],a=g.ow(n);V.sO({environment:this.environment,editorMode:"default",store:y,value:a,transaction:e}),o&&o.state.isOpen&&o.state.collectionContextStore&&(I.rv({environment:this.environment,collectionContextStore:o.state.collectionContextStore,block_id:h.id,property:i,property_type:"relation",from:"relation_section",isFromBulkActionsToolbar:!1,integration_id:p.id,action:"add"}),w.W(this.environment,{...(0,ee.Pn)(o.state.collectionContextStore),from:"relation_menu",type:"page",integration_id:p.id,creating_block_id:h.id}))}}),this.stores.store.reset()}finally{this.stores.store.setState({...this.stores.store.state,addingPage:!1})}},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchInputChange=e=>function(e,t){const o=e.target.value;t.setState({...t.state,searchQuery:o,searchLimit:Se.Z.limitIncrement})}(e,this.stores.store),this.handleMobileTargetCollectionClick=()=>{const e=this.getRenderState();e&&(N.c4({environment:this.environment,url:e.targetParentUrl}),O.ZZ(this.environment,{from:this.props.analyticsFrom}))},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchInputClick=()=>function(e){const t=e.state;e.setState({...e.state,searchQuery:t.searchQuery,searchPopupOpen:!0,searchLimit:Se.Z.limitIncrement})}(this.stores.store),this.handleSelectedPageClick=(e,t)=>{const{mainEditorCurrentBlockStore:o}=de.default.state;if(!o)return;let r;if(t){const t=ue.G.createChildStore(o,e.pointer),n=t.isDefined()?this.maybeOverwriteBaseUrlFromSpaceId(t.getSpaceId()):void 0;r=(0,y.Z)({pageId:e.pointer.id,pageModel:t.getModel(),baseUrl:n,pageVisitSource:d.tY.LinkInPage})}else{const t=o.isDefined()?this.maybeOverwriteBaseUrlFromSpaceId(o.getSpaceId()):void 0;r=(0,y.Z)({pageId:o.id,pageModel:o.getModel(),baseUrl:t,peekViewBlockId:e.pointer.id,pageVisitSource:d.tY.LinkInPage})}N.c4({environment:this.environment,url:r,openInNew:t}),O.XX(this.environment,{from:this.props.analyticsFrom,meta_click:Boolean(t)})},this.handleValueRelationPropertyMenuResultsAccept=(e,t)=>{e.type===ye.Rt.SelectedPage&&this.handleSelectedPageClick(e,t)},this.handleSearchRelationPropertyMenuResultsAccept=(e,t)=>{var o;if(this.props.disabled)return;const{value:r,onChange:n,overlayMode:i}=this.props,{mainEditorCurrentBlockStore:a}=de.default.state;if(!a)return;const s=null===(o=this.getRenderState())||void 0===o?void 0:o.propertySchema.limit;if(e.type===ye.Rt.SearchPage){var l,d,c,p;n({value:s?[e.pointer]:"add"===(null==i?void 0:i.type)?[...r.slice(0,i.index),e.pointer,...r.slice(i.index)]:[...r,e.pointer]}),O.dw(this.environment,{from:this.props.analyticsFrom,collection_id:null===(l=this.props.collectionStore)||void 0===l?void 0:l.id,collection_view_id:null===(d=this.context.collectionContextStore)||void 0===d||null===(d=d.collectionViewStore())||void 0===d?void 0:d.id,collection_view_block_id:null===(c=this.context.collectionContextStore)||void 0===c||null===(c=c.collectionViewBlockStore())||void 0===c?void 0:c.id,target_collection_id:null===(p=this.getRenderState())||void 0===p||null===(p=p.targetCollectionStore)||void 0===p?void 0:p.id})}else e.type===ye.Rt.SelectedPage&&this.handleSelectedPageClick(e,t)},this.handleCreateNewPage=e=>{var t,o,r;const{searchQuery:n}=this.stores.store.state,i=(0,_.ZP)(),a=null===(t=this.getRenderState())||void 0===t?void 0:t.targetCollectionStore.getSpaceId(),{value:s,onChange:l}=this.props,d=null===(o=this.getRenderState())||void 0===o?void 0:o.propertySchema.limit,c={id:i,table:R.iU,spaceId:a};l({newPage:{id:i,spaceId:a,name:n},value:d?[c]:e?[...s.slice(0,e),c,...s.slice(e)]:[...s,c]}),w.W(this.environment,{...(0,ee.Pn)(this.context.collectionContextStore),from:"relation_menu",type:"page",target_collection_id:null===(r=this.getRenderState())||void 0===r||null===(r=r.targetCollectionStore)||void 0===r?void 0:r.id,new_page_id:i,creating_block_id:i})},this.handleClickActionButton=e=>{var t;const{value:o,onChange:r,overlayMode:n}=this.props,{mainEditorCurrentBlockStore:i}=de.default.state;if(!i)return;const a=null===(t=this.getRenderState())||void 0===t?void 0:t.propertySchema.limit;if(e.type===ye.Rt.SearchPage){var s;r({value:a?[e.pointer]:"add"===(null==n?void 0:n.type)?[...o.slice(0,n.index),e.pointer,...o.slice(n.index)]:[...o,e.pointer]}),O.dw(this.environment,{from:this.props.analyticsFrom,...(0,ee.Pn)(this.context.collectionContextStore),target_collection_id:null===(s=this.getRenderState())||void 0===s||null===(s=s.targetCollectionStore)||void 0===s?void 0:s.id})}else if(e.type===ye.Rt.SelectedPage){var l;r({value:a?[]:o.filter((t=>t.id!==e.pointer.id))}),O.WF(this.environment,{...(0,ee.Pn)(this.context.collectionContextStore),from:this.props.analyticsFrom,target_collection_id:null===(l=this.getRenderState())||void 0===l||null===(l=l.targetCollectionStore)||void 0===l?void 0:l.id})}var d;a&&(null===(d=this.props.blockPropertyValueOverlayStore)||void 0===d||d.setState({isOpen:!1}))},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchMenuClickRight=()=>{!function(e){e.reset()}(this.stores.store)},this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchScrollOffsetChange=e=>function(e,t,o){const{loading:r,result:n}=o.state;e<Se.Z.incrementScrollOffset&&n&&!r&&n.results.length>=t.state.searchLimit&&t.setState({...t.state,searchLimit:t.state.searchLimit+Se.Z.limitIncrement})}(e,this.stores.store,this.stores.requestStore),this.performSearchRequest=async e=>{const{disabled:t}=this.props,o={results:[],query:e.query},r=this.getRenderState();if(!r)return o;if(t)return o;if(g.gg(r.propertySchema)||g.ic(r.propertySchema))return o;const{targetCollectionStore:n}=r;let i=[];if(n.getFormatStore().getKeyStore("app_config_uri").getValue()===c.p$)try{return i=Xe(await async function(e){const{environment:t,sprintCollectionStore:o,searchQuery:r}=e,n=o.getPropertyMapping(),i=null==n?void 0:n[p.b0.StatusV2],a=null==n?void 0:n[p.b0.Dates];if(!i||!a)throw new Error("Sprints database does not have the required properties");const s="results",l={userTimeZone:(0,f.r)(),searchQuery:r,sort:[{property:i,direction:"ascending"},{property:a,direction:"ascending"}],reducers:{[s]:{type:"results",limit:100}}},d=o.getParentBlockStore();if(!d)return[];await d.load();const c=d.getCollectionViewStores()[0];if(!c)return[];const u=o.getSpaceId(),g=await j.queryCollection(t,{source:{type:"collection",id:o.id,spaceId:u},collectionView:{id:c.id,spaceId:u},loader:l},void 0,{src:"relation_property_menu"});if("success"!==g.type)return[];const h=g.data.result.reducerResults[s];if("results"!==h.type)return[];return h.blockIds}({environment:this.environment,sprintCollectionStore:n,searchQuery:e.query}),n,r.propertySchema,this.props.value),{results:i,query:e.query}}catch(a){}try{const t=await ae.deps.searchActions.loader(),{results:o}=await t.searchPagesInCollection({environment:this.environment,query:e.query,collectionId:n.id,limit:e.limit,spaceId:n.getSpaceId(),excludeTemplates:!0,source:"relation_menu",includePublicPagesWithoutExplicitAccess:!0,boostRecentlyViewedPages:!0,ignoresHighlight:!0});i=Xe(o,n,r.propertySchema,this.props.value)}catch(a){m.log({level:"error",from:"relationPropertyMenu",type:"search",error:(0,x.Ui)(a)})}return{results:i,query:e.query}},this.getRecordModel=v.om.fromMonomorphicFunctionUnsafe((e=>ue.G.createChildStore(this.props.blockStore,e).getRecordModel(e)),C.mF.fromMonomorphicFunctionUnsafe((e=>{const t=ue.G.createChildStore(this.props.blockStore,e);return t.computeWithRecordValues((e=>{let{getRecordValueAndSubscribe:o}=e;return o(t)}))})))}didMount(){super.didMount(),i.default.afterNextFlush((()=>{i.default.afterNextFlush((()=>{const e=this.getRenderState();if(e){0===this.getValueResults(e).length&&this.stores.store.setState({searchPopupOpen:this.environment.device.isMobile,searchQuery:this.props.insertChar??"",searchLimit:Se.Z.limitIncrement,addingPage:!1})}}))}))}renderComponent(){const{device:e}=this.environment,t=this.getRenderState();if(t)return(0,Ne.jsx)(D.Z,{capture:!0,allowMenuList:!0,allowEsc:!0,allowUndo:!0,allowTabUntab:!0,render:()=>e.isMobile?this.renderMobileMenu(t):this.renderDesktopMenu(t)})}renderDesktopMenu(e){const{searchQuery:t}=this.stores.store.state,o=this.stores.requestStore.state.result,{blockStore:r,disabled:n,analyticsFrom:i,overlayMode:a}=this.props,{targetCollectionStore:s}=e,l=Boolean(pe.Z.bots.state.find((e=>e.integration_id===S.U9))),d=g.Kp(e.propertySchema),c=g.gg(e.propertySchema),p=g.ic(e.propertySchema),u=g.U8(e.propertySchema),h=d&&!l||(c||p||u)&&!this.isMemberOfSpace.state,y=a&&"add"===a.type?a.index:void 0;return(0,Ne.jsx)(Q.Z,{menuType:oe.og.Popup,header:h?null:(0,Ne.jsx)(He,{store:this.stores.store,disabled:n,renderState:e,blockStore:r,analyticsFrom:i,isConnectedRelation:Boolean(e.propertySchema.connectedRelation),overlayMode:a,addPage:this.addPage}),footer:this.renderFooter({requestStateResult:o,searchQuery:t,overlayMode:a,disabled:n,targetCollectionStore:s,index:y,propertySchema:e.propertySchema}),children:(0,Ne.jsx)("div",{style:{overflow:"hidden",maxHeight:"70vh"},children:this.renderSearchResults(e)})})}renderFooter(e){const{requestStateResult:t,searchQuery:o,overlayMode:r,disabled:n,targetCollectionStore:i,index:a,propertySchema:s}=e;return!(i.getFormatStore().getKeyStore("app_config_uri").getValue()===c.p$)&&"view"===(null==r?void 0:r.type)||n||s.connectedRelation?null:t&&t.results.length>0&&o&&(0,Ne.jsx)(z.Z,{targetCollectionStore:i,title:o,onClick:this.handleCreateNewPage,focused:!1,isSection:!0,index:a})}renderMobileMenu(e){const{device:t}=this.environment,{searchPopupOpen:o}=this.stores.store.state,{collectionStore:r,property:n,schema:i,blockStore:a,blockPropertyValueOverlayStore:s,disabled:l,canConfigureCollection:d,onDismiss:c}=this.props,{showProperties:p,targetCollectionStore:h}=e,{mediumTextColor:y}=this.theme,m=this.getValueResults(e),f=i[n],v=f&&u.NK(f),C=Boolean(pe.Z.bots.state.find((e=>e.integration_id===S.U9))),R=Boolean(pe.Z.bots.state.find((e=>e.integration_id===S.f3))),b=Boolean(pe.Z.bots.state.find((e=>e.integration_id===S.mQ))),x=g.Kp(e.propertySchema),_=g.gg(e.propertySchema),k=g.ic(e.propertySchema),O=x&&!C||_&&!R||k&&!b;return(0,Ne.jsxs)(Q.Z,{menuType:oe.og.Modal,title:e.propertySchema.name,right:(0,Ne.jsx)(M.FormattedMessage,{defaultMessage:"Done",id:"relationPropertyMenu.mobileMenuDone.button"}),onClickRight:c,children:[v?null:(0,Ne.jsx)(H.Z,{disableMobilePadding:!0,children:(0,Ne.jsx)(E.Z,{focused:!1,title:(0,Ne.jsx)("div",{style:{display:"flex"},children:(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.newRelation.targetDatabase",defaultMessage:"<regular>In</regular> {databaseWithIcon}",values:{regular:e=>e,databaseWithIcon:(0,Ne.jsxs)("div",{style:{display:"flex",marginLeft:2*ye.Qi},children:[(0,Ne.jsx)(G.Z,{disabled:!0,icon:h.getIcon(),isEmptyPage:!1,size:20}),(0,Ne.jsx)(K.Z,{store:h,underline:!0,style:{marginLeft:ye.Qi}})]})}})}),showExtensionArrow:!1,onClick:this.handleMobileTargetCollectionClick})}),O?null:(0,Ne.jsx)(H.Z,{topBorder:!0,disableMobilePadding:!1,children:(0,Ne.jsx)(q.GI,{popupType:q.kQ.SlideUp,open:o,origin:(0,Ne.jsx)(E.Z,{focused:!1,title:(0,Ne.jsxs)("span",{style:{display:"flex",alignItems:"center"},children:[(0,P.R)({marginRight:8,width:t.isMobile?16:14,height:t.isMobile?16:14}),(0,Ne.jsx)(M.FormattedMessage,{defaultMessage:"Add a page",id:"relationPropertyMenu.addAPage.button"})]}),onClick:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchInputClick,style:{color:y}}),render:()=>this.renderSearchResults(e)})}),(0,Ne.jsx)(Ee,{collectionStore:r,targetCollectionStore:h,showProperties:p,results:m,resultsType:"existing",property:n,schema:i,parentStore:a,disabled:l,canConfigureCollection:d,loading:!1,canDrag:!1,blockPropertyValueOverlayStore:s,onAccept:this.handleValueRelationPropertyMenuResultsAccept,onClickActionButton:this.handleClickActionButton,onCreatePage:this.handleCreateNewPage,handleClearProperty:()=>Je(this.props.onChange),relationPropertyMenuStore:this.stores.store,addPage:this.addPage,addingPage:this.stores.store.state.addingPage})]})}renderSearchResults(e){const{device:t}=this.environment,{collectionStore:o,value:r,property:n,schema:i,blockStore:a,blockPropertyValueOverlayStore:s,disabled:l,canConfigureCollection:d,overlayMode:c}=this.props,{requestStore:p}=this.stores,{showProperties:y,targetCollectionStore:S,propertySchema:m}=e,{searchQuery:P,searchLimit:v}=this.stores.store.state;let C=se.default.mark("rum.relation_search_query");const b=m.limit?r.slice(0,1):r,x={request:{query:P,limit:v},debounce:le.vp,performRequest:this.performSearchRequest,render:(r,p)=>{let v=[];v=P?this.getValueResults(e).filter((e=>{let{pageResult:t}=e;const o=ue.G.createChildStore(this.props.blockStore,t.pointer),r=o.getModel();if(r)return(0,h.fY)({block:r,query:P,getRecordModel:o.getRecordModel,userTimeZone:(0,f.r)(),schema:i,intl:te.default.getIntl(),onlyPropertyIds:["title"]})})):this.getValueResults(e);const x=!p&&0===v.length,_=v;p&&p.results.forEach((e=>{const t=e.pageResult;if((t.type===ye.Rt.SelectedPage||t.type===ye.Rt.SearchPage)&&v.find((e=>(e.pageResult.type===ye.Rt.SelectedPage||e.pageResult.type===ye.Rt.SearchPage)&&e.pageResult.pointer.id===t.pointer.id)))return;const o=e.pageResult.type!==ye.Rt.NewPage?b.map((e=>e.id)).includes(e.pageResult.pointer.id):void 0;o&&!P&&"add"===(null==c?void 0:c.type)||(e.pageResult.type===ye.Rt.SearchPage&&o?_.push({...e,pageResult:{...e.pageResult,type:ye.Rt.SelectedPage}}):e.pageResult.type!==ye.Rt.SelectedPage||o?_.push(e):_.push({...e,pageResult:{...e.pageResult,type:ye.Rt.SearchPage}}))})),!x&&""!==P&&C&&p&&p.query===P&&(se.default.measure(C,{environment:this.environment}),C=void 0);const k=(0,Ne.jsx)(Ee,{collectionStore:o,targetCollectionStore:S,showProperties:y,results:_,resultsType:0===_.length&&0===this.getValueResults(e).length?"existing":"search",property:n,schema:i,parentStore:a,disabled:l,canConfigureCollection:d,loading:x,canDrag:!l&&0===P.length,blockPropertyValueOverlayStore:s,onAccept:this.handleSearchRelationPropertyMenuResultsAccept,onClickActionButton:this.handleClickActionButton,onScrollOffsetChange:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchScrollOffsetChange,onDrag:e=>function(e,t,o,r,n){o({value:e.map((e=>({id:e,spaceId:t.pointer.spaceId,table:R.iU})))}),O.yT(n,{from:r})}(e,this.props.collectionStore,this.props.onChange,this.props.analyticsFrom,this.environment),onCreatePage:this.handleCreateNewPage,handleClearProperty:()=>Je(this.props.onChange),searchQuery:P,overlayMode:c,relationPropertyMenuStore:this.stores.store,addPage:this.addPage,addingPage:this.stores.store.state.addingPage});if(t.isMobile){let e=te.default.formatMessage(Ge.inputPlaceholder);const o=u.NK(m);return o&&(e=te.default.formatMessage(Ge.connectedRelationInputPlaceholder)),g.gg(m)&&(e=te.default.formatMessage(Ge.connectedRelationGoogleDriveInputPlaceholder)),g.ic(m)&&(e=te.default.formatMessage(Ge.connectedRelationFigmaInputPlaceholder)),g.Kp(m)&&(e=te.default.formatMessage(Ge.connectedRelationGithubInputPlaceholder)),(0,Ne.jsx)(Q.Z,{menuType:oe.og.Modal,title:(0,Ne.jsx)(M.FormattedMessage,{defaultMessage:"Relation",id:"relationPropertyMenu.mobileRelationMenu.title"}),left:(0,Ne.jsx)($e,{}),right:(0,Ne.jsx)(M.FormattedMessage,{defaultMessage:"Done",id:"relationPropertyMenu.mobileDoneButton"}),header:(0,Ne.jsxs)(Ne.Fragment,{children:[(0,Ne.jsx)(A.ZP,{value:P,disabled:l,onChange:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleSearchInputChange,placeholder:e,showClearButton:!0,focus:!t.isMobile||void 0,focusInitial:!0,style:{...t.isAndroid&&{borderBottom:"none"}}}),P&&!l&&!o&&(0,Ne.jsx)(z.Z,{targetCollectionStore:S,title:P,onClick:this.handleCreateNewPage,focused:!1,isSection:!0})]}),onClickRight:this.CLASS_COMPONENT_CONVERSION_DO_NOT_TOUCH_handleMobileSearchMenuClickRight,children:k})}return k}};return(0,Ne.jsx)($.Z,{...x,requestStore:p})}getRenderState(){const{schema:e,property:t,blockStore:o,collectionStore:r}=this.props,n=e[t];if(!n||"relation"!==n.type)return;const i=u.j0(n);if(!i)return;const a=ue.NW.createChildStore(o,i),s=a.getParentId();if(!s)return;const l=ue.G.createChildStore(a,{table:R.iU,id:s}),d=u.oC({id:a.id,schema:a.getSchema(),format:a.getFormat(),space_id:a.getSpaceId()}),c=[d[u.bf]?u.bf:u.iw],p=l.isDefined()?this.maybeOverwriteBaseUrlFromSpaceId(l.getSpaceId()):void 0,g=(0,y.Z)({pageId:l.id,pageModel:l.getModel(),baseUrl:p,pageVisitSource:void 0});return{propertySchema:n,property:t,targetCollectionStore:a,targetParentBlock:l,showProperties:c,targetCollectionSchema:d,targetParentUrl:g,collectionStore:r}}getValueResults(e){const{value:t,overlayMode:o}=this.props,{propertySchema:r,targetCollectionStore:n}=e,{searchQuery:i}=this.stores.store.state;return i||"add"!==(null==o?void 0:o.type)?g.j$({relationValue:t,propertySchema:r,getRecordModel:this.getRecordModel}).map((e=>({pageResult:{key:e.id,type:ye.Rt.SelectedPage,pointer:e},canEdit:Ye(n,r,e)}))):[]}}function He(e){var t;const o=(0,a.O7)(),r=(0,a.Fy)(),{targetParentUrl:n,targetCollectionStore:i,propertySchema:d}=e.renderState,[p,u,h]=(0,s.AF)(e.store),{searchQuery:y,searchPopupOpen:S}=p,m=(0,s.VK)((()=>i.getIcon()),[i]),f=(0,s.VK)((()=>i.isSyncedCollection()),[i]),P=(0,s.VK)((()=>g.Kp(d)),[d]),v=(0,s.VK)((()=>g.gg(d)),[d]),C=(0,s.VK)((()=>g.ic(d)),[d]),R=(0,s.VK)((()=>i.getFormatStore().getKeyStore("app_config_uri").getValue()===c.p$),[i]),b=(0,l.yK)((e=>({regular:{color:e.mediumTextColor,whiteSpace:"nowrap",marginLeft:4},headerWrap:{display:"flex",width:"100%",position:"relative",zIndex:2,padding:"6px 10px",fontSize:14,background:e.inputBackground,boxShadow:`\n\t\t\t\t\t0 1px 0 ${e.darkDividerColor}\n\t\t\t\t`},recordTitle:{fontWeight:k.Z.fontWeight.semibold,fontSize:14,marginLeft:ye.Qi*(r.isRetina?.5:1)},searchIcon:{fill:e.mediumIconColor,width:14,height:14,marginRight:10}})),[r.isRetina]);let x=Ge.inputPlaceholder;if(f)x=Ge.syncedCollectionInputPlaceholder;else if(P)x=Ge.connectedRelationGithubInputPlaceholder;else if(v)x=Ge.connectedRelationGoogleDriveInputPlaceholder;else if(C)x=Ge.connectedRelationFigmaInputPlaceholder;else if(R){var _;"view"===(null===(_=e.overlayMode)||void 0===_?void 0:_.type)&&(x=Ge.sprintTypedPropertyInputViewPlaceholder),x=Ge.sprintTypedPropertyInputAddPlaceholder}else e.isConnectedRelation?x=Ge.connectedRelationInputPlaceholder:("view"===(null===(t=e.overlayMode)||void 0===t?void 0:t.type)||e.disabled)&&(x=Ge.searchLinkedInputPlaceholder);const I=te.default.formatMessage(x);return(0,Ne.jsxs)("div",{style:b.headerWrap,children:[(0,Ne.jsx)(B.Z,{style:{flexGrow:1},value:y,placeholder:I,forceShowClearButton:Boolean(y||S),focus:!0,onChange:e=>{const t=e.target.value;u({...p,searchQuery:t,searchPopupOpen:!!t,searchLimit:Se.Z.limitIncrement})},onClearButtonClick:()=>{u(h.getInitialState())},onClick:()=>{u({...p,searchQuery:p.searchQuery,searchPopupOpen:!0,searchLimit:Se.Z.limitIncrement})},onKeyDown:e=>{"Escape"===e.key&&u(h.getInitialState())},format:B.B.Transparent,onSubmit:()=>(()=>{const t=i.getFormat().integration_id,o=pe.Z.integrations.state.find((e=>e.id===t)),r=i.getFormat().pattern_name;if(!o||!r)return;ze({integration:o,patternName:r,url:p.searchQuery})&&e.addPage()})()}),!e.isConnectedRelation&&!R&&(0,Ne.jsx)("div",{style:{display:"flex",marginLeft:10,alignItems:"center"},children:(0,Ne.jsx)(M.FormattedMessage,{id:"database.relationProperty.newRelation.targetDatabase",defaultMessage:"<regular>In</regular> {databaseWithIcon}",values:{regular:e=>(0,Ne.jsx)("span",{style:b.regular,children:e}),databaseWithIcon:(0,Ne.jsxs)(U.Z,{href:n,style:{marginLeft:ye.Qi},innerStyle:{display:"flex"},onClick:()=>{O.ZZ(o,{from:e.analyticsFrom})},children:[(0,Ne.jsx)(G.Z,{disabled:!0,icon:m,isEmptyPage:!1,size:20}),(0,Ne.jsx)(K.Z,{store:i,underline:!0,style:b.recordTitle})]})}})})]})}Ke.displayName="RelationPropertyMenu",Ke.contextTypes={...n.w,...Y.xm};const We=Ke;function ze(e){var t;if(e.patternName)return null===(t=e.integration.info)||void 0===t||null===(t=t.original_url_patterns)||void 0===t?void 0:t.filter((t=>{var o;return t.name===e.patternName&&(null===(o=t.additional_types)||void 0===o?void 0:o.connectedRelation)})).find((t=>{let{regex:o}=t;return new RegExp(o).test(e.url)}))}function Ye(e,t,o){if(!(Boolean(t.property)&&ce.default.checkGate("collections_relation_picker_require_edit_perms")))return!0;return ue.G.createChildStore(e,o).canEdit()}function $e(){return(0,Ne.jsx)(W.Z,{href:(0,ie.UY)("guides.relations"),analyticsFrom:"relation_menu"})}function Xe(e,t,o,r){const n=new Set(r.map((e=>e.id))),i=[];return e.forEach((e=>{const r={spaceId:t.getSpaceId(),id:e,table:R.iU},a=Ye(t,o,r);if(n.has(e)){const t={key:e,type:ye.Rt.SelectedPage,pointer:r};i.push({pageResult:t,canEdit:a})}else{const t={key:e,type:ye.Rt.SearchPage,pointer:r};i.push({pageResult:t,canEdit:a})}})),i}function Je(e){e({value:[]})}}}]);