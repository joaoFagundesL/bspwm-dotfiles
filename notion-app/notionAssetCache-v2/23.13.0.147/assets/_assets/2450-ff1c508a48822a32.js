"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[2450],{32450:(e,t,n)=>{n.r(t),n.d(t,{DictationBubble:()=>gt,StopDictationButton:()=>Ct,dictationActions:()=>o});var o={};n.r(o),n.d(o,{AudioSessionBlockWriter:()=>Ue,DictationManager:()=>Qe,Segment:()=>We,smartToggleDictation:()=>Je,startDictation:()=>Ye,stopDictation:()=>et});n(57658),n(21703);var i=n(41432),s=n(70203),r=n(94419),a=n(9953),c=n(993),l=n(13447);var d=n(12847);const u=d.union([d.number(),d.string(),d.boolean(),d.isNull(),d.array(d.string())]),p=d.undefinable(u),h=(d.union([u,d.record(d.string(),u)]),d.union([p,d.record(d.string(),p)])),f=(d.union([h,d.record(d.string(),h)]),d.without(d.without(d.nonEmpty(d.string()),"{"),"}"),d.union([d.object({required:{id:d.string(),status:d.literal("pending"),audioDuration:d.number()},optional:{}}),d.object({required:{id:d.string(),status:d.literal("complete"),text:d.string(),audioDuration:d.number()},optional:{}}),d.object({required:{id:d.string(),status:d.literal("error"),reason:d.string(),audioDuration:d.number()},optional:{}}),d.object({required:{id:d.string(),status:d.literal("ignore"),audioDuration:d.number()},optional:{}})])),m=d.union([d.object({required:{type:d.literal("transcription"),audioSessionId:d.string(),segmentId:d.string(),transcription:f,isSegmentComplete:d.boolean(),isAudioSessionComplete:d.boolean()},optional:{}}),d.object({required:{type:d.literal("response"),status:d.literals("ok","error"),requestId:d.string(),result:d.any()},optional:{}})]);d.object({required:{base64Audio:d.string()},optional:{language:d.string()}}),d.object({required:{},optional:{}}),d.object({required:{},optional:{language:d.string()}}),d.object({required:{},optional:{}}),d.object({required:{},optional:{}}),d.object({required:{},optional:{}});var g=n(68626),v=n(90038),S=n(53965),w=n(52629),b=n(76870),k=n(37850),y=n(7032),C=n(1525),x=n(19584),R=n(63811),I=n(95477),P=n(22705);n(88632);const M=!1;var B=n(1302),D=n(97978),T=n(77080);function A(e,t){B.default.afterNextFlush((()=>{T.default.checkGate("audio_processor_client_send_request_metric_enabled")&&D.j(e,"audio_processor.client.send_request",t)}))}const q={all:E=E||new Map,on:function(e,t){var n=E.get(e);n?n.push(t):E.set(e,[t])},off:function(e,t){var n=E.get(e);n&&(t?n.splice(n.indexOf(t)>>>0,1):E.set(e,[]))},emit:function(e,t){var n=E.get(e);n&&n.slice().map((function(e){e(t)})),(n=E.get("*"))&&n.slice().map((function(n){n(e,t)}))}};var E;const _="transcription",j=async()=>n.e(7168).then(n.bind(n,69053)),Z=!1,F=90*x.C0;function L(e){return{_id:e,charactersSent:0,requestsSent:0,requestsTimedOut:0,responsesReceivedWithoutHandlers:0,successfulResponsesReceived:0,unsuccessfulResponsesReceived:0,invalidMessagesReceived:0,notificationsReceived:0,messagesReceived:0}}const $=new v.z(20),O=new Map,N=(Date.now(),"audioProcessorInternals"),z=new g.BatchedLogger({from:N,type:"BulkDebug",level:"info",maxLength:250,logToConsole:Z});let V,W=0,K=0,U=0,G=0,H=L(0),X=null,Q=null,J=null,Y=0,ee=C.O,te=!1,ne="uninitialized";const oe=!0;function ie(e){z.log({level:"info",from:N,type:e})}function se(){V=function(e){var t;const n=null==e||null===(t=e.socket)||void 0===t||null===(t=t.transport)||void 0===t||null===(t=t.query)||void 0===t?void 0:t.transport;if("websocket"===n||"polling"===n)return n}(this),ie(`ping:${V}`),X=Date.now(),we(`Incoming primus ping received from server via ${V}.`)}function re(){return{...$.getStats()}}function ae(e){switch(z.log({level:"info",from:N,type:"readyStateChange",data:{message:e}}),J=Date.now(),e){case"end":ne="closed";break;case"open":ne="open";break;case"opening":ne="opening"}}const ce=S.HP((e=>async function(e){if(M)return;if(ve(e))return void g.log({level:"warning",from:N,type:"CreatePrimusClientCalledForNativeAudioProcessorClient"});W+=1;const{createClient:t}=await j(),n=t({minReconnectDelayMs:.5*x.C0,maxReconnectDelayMs:1*x.C0});return n.on("data",me),n.on("open",(()=>{ie("open"),le(e)})),n.on("reconnected",(e=>{he(),z.log({level:"info",from:N,type:"reconnected",data:{message:`Reconnected in ${null==e?void 0:e.duration} ms`}})})),n.on("reconnect",(()=>{ie("reconnect")})),n.on("reconnect scheduled",(e=>{z.log({level:"info",from:N,type:"reconnect scheduled",data:{message:`Reconnecting in ${null==e?void 0:e.scheduled} ms, attempt ${null==e?void 0:e.attempt} of ${null==e?void 0:e.retries}`}})})),n.on("reconnect timeout",(()=>{ie("reconnect timeout")})),n.on("reconnect failed",(()=>{ie("reconnect failed")})),n.on("timeout",(()=>{ie("timeout")})),n.on("destroy",(()=>{ie("destroy")})),n.on("close",(()=>{ie("close")})),n.on("online",(()=>{ie("online")})),n.on("offline",(()=>{ie("offline")})),n.on("error",(e=>{let t;t="TransportError"===e.type?{level:"info",from:N,type:"primusTransportError",error:(0,w.Ui)(e)}:{level:"error",from:N,type:"unknownPrimusError",error:(0,w.Ui)(e)};(0,b.lB)(1)&&g.rateLimitedLog(t),z.log(t),U+=1})),n.on("incoming::ping",se),n.on("readyStateChange",ae),n.on("end",(()=>{ie("end"),n.off("readyStateChange",ae),K+=1,async function(e,t){var n,o;g.log({level:"info",from:N,type:"audioProcessorEnd",error:{message:`SocketId: ${null==e||null===(n=e.socket)||void 0===n?void 0:n.id} Query:${null==e||null===(o=e.transport)||void 0===o?void 0:o.query}`}}),pe(),ee.setTimeout((()=>{void 0!==e&&e.destroy()}),0);const i=await ce(t);if(e!==i)return;ce.cache.clear(),ee.setTimeout((()=>{ce(t)}),2*x.C0)}(n,e)})),window.__primusClient=n,n}(e)),(function(){return"primus_audioProcessor"}));function le(e){H=L(H._id+1),Z&&function(){const e=Date.now(),t=20;function n(){const o=re();if(0===o.queue&&0===o.running)return we(`Queues emptied after ${Date.now()-e} ms`),void(de=void 0);de=window.setTimeout(n,t)}de&&window.clearTimeout(de);we("Starting measurement of time until send queues are empty."),n()}()}let de,ue;function pe(){var e;te=!1,function(){for(const e of O.values())window.clearTimeout(e.timeout);O.clear()}(),$.cancel(),null===(e=ue)||void 0===e||e()}function he(){P.ZP.state.enabled||pe()}function fe(e){if(M)return;const{method:t,request:n,environment:o}=e;A(o,{status:"enqueued",endpoint:t});const i=$.enqueue((()=>{var i;const s=(0,y.ZP)();!function(e,t){B.default.afterNextFlush((()=>{T.default.checkGate("audio_processor_client_send_request_metric_enabled")&&(D.j(e,"audio_processor.client.send_request.queue_running_size",{value:t.running}),D.j(e,"audio_processor.client.send_request.queue_backup_size",{value:t.queue}))}))}(o,$.getStats());const r=k.UZ(),a=Date.now(),c=oe?window.setTimeout((()=>{"open"===ne&&(H.requestsTimedOut+=1,z.log({level:"info",from:N,type:"requestTimeout",data:{requestId:s,time:Date.now()-a}}))}),F):void 0;O.set(s,{resolve:r.resolve,reject:r.reject,timeout:c,sendTime:a}),z.log({level:"info",from:N,type:"requestSent",data:{requestId:s,method:t}});const l={type:`${I.default.audioProcessor.api}/${t}`,requestId:s,...n};return H.requestsSent+=1,async function(e){const{message:t,environment:n}=e,o=ge(n),i=JSON.stringify(t);H.charactersSent+=i.length,Y<i.length&&(Y=i.length);if(o)o(i);else{const e=await ce(n);null==e||e.write(t)}}({message:l,environment:o}),null===(i=e.onRequestSent)||void 0===i||i.call(e),r.promise.then((e=>{A(o,{status:"success",endpoint:t})})).catch((e=>{const n=$.getStats();A(o,{status:"failure",endpoint:t,queue_running_size:n.running,queue_backup_size:n.queue})})),r.promise}));return{response:i.catch((e=>{e instanceof Se&&!ve(o)&&!te?(te=!0,G+=1,ie("connectionResetDueToFailedRequest"),ce(o).then((e=>{null==e||e.end()})),we(`sendRequest() for ${t} returned server error (${e.message}), resetting connection`,n)):we(`sendRequest() cancelled or errored for ${t} (${e.message})`,n)})),asyncQueuePromise:i}}function me(e){H.messagesReceived+=1;const t=(0,R.Gu)(m,e);if(t)return H.invalidMessagesReceived+=1,void g.rateLimitedLog({level:"warning",from:N,type:"ValidationError",data:{miscDataToConvertToString:e},error:(0,w.Ui)(t)});const n=e;switch(n.type){case"response":{var o;const{requestId:e,status:t,result:i}=n,s=O.get(e);if(O.delete(e),z.log({level:"info",from:N,type:"responseReceived",data:{requestId:e,response:t,time:s&&Date.now()-s.sendTime,internalProcessingTimeMs:null===(o=n.result)||void 0===o?void 0:o.internalProcessingTimeMs}}),!s)return void(H.responsesReceivedWithoutHandlers+=1);Q=Date.now(),window.clearTimeout(s.timeout),"ok"===t?(H.successfulResponsesReceived+=1,s.resolve(i)):(H.unsuccessfulResponsesReceived+=1,s.reject(new Se(i)));break}case"transcription":q.emit(_,n)}}function ge(e){}function ve(e){return Boolean(void 0)}class Se extends Error{constructor(e){super(e),this.name="FailedAudioProcessorRequestError"}}function we(){if(Z){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.info("audioProcessorInternals:",...t)}}var be=n(28020),ke=n(98165),ye=n(83212),Ce=n(26842),xe=n(27724),Re=n(17277);n(48675),n(63408),n(14590),n(3462),n(23767),n(8585),n(68696);class Ie{constructor(e,t){this._inputSampleRate=void 0,this._outputSampleRate=void 0,this._inputSampleRate=e,this._outputSampleRate=t}downsample(e){const t=this.downSampleAudioFrame(e,this._inputSampleRate,this._outputSampleRate),n=new ArrayBuffer(4*t.length),o=new DataView(n);for(let i=0,s=0;i<t.length;i++,s+=4){const e=Math.max(-1,Math.min(1,t[i]));o.setFloat32(s,e,!0)}return n}downSampleAudioFrame(e,t,n){if(n===t||n>t)return e;const o=t/n,i=Math.round(e.length/o),s=new Float32Array(i);let r=0,a=0;for(;a<i;){const t=Math.round((a+1)*o);let n=0,i=0;for(;r<t&&r<e.length;)n+=e[r++],i++;s[a++]=n/i}return s}}var Pe=n(49085);function Me(){const e=navigator.mediaDevices;if(e instanceof MediaDevices)return e;throw new Error("Media devices unavailable in current context.")}const Be="initial",De="allowed",Te="denied",Ae="no_devices",qe="insecure_context",Ee="unknown_error";class _e extends Pe.default{async checkPermissions(){const e=await _e.checkAudioPermissionsThrottled();return this.setState(e),e}getInitialState(){return window.isSecureContext?Be:qe}}_e.checkAudioPermissionsThrottled=(0,S.P2)((async()=>{if(!window.isSecureContext)return qe;try{const e=Me();return function(e){for(const t of e.getTracks())t.stop()}(await e.getUserMedia({video:!1,audio:!0})),De}catch(e){if(e instanceof Error)switch(e.name){case"NotAllowedError":return Te;case"NotFoundError":return Ae}return Ee}}),1e3);const je=new _e;n(30541);var Ze=n(14577);class Fe extends Pe.default{async updateMediaDevices(){try{const e=await async function(){const e=Me(),t=(await e.enumerateDevices()).reduce(((e,t)=>{switch(t.kind){case"videoinput":"default"!==t.deviceId?e.videoInput.push(t):e.defaultVideoInput=t;break;case"audioinput":"default"!==t.deviceId?e.audioInput.push(t):e.defaultAudioInput=t;break;case"audiooutput":"default"!==t.deviceId?e.audioOutput.push(t):e.defaultAudioOutput=t}return e}),{videoInput:[],audioInput:[],audioOutput:[]}),{defaultVideoInput:n,defaultAudioInput:o,defaultAudioOutput:i}=t;if(n){const e=t.videoInput.findIndex((e=>n.label.includes(e.label)));e&&t.videoInput.unshift(t.videoInput.splice(e,1)[0])}if(o){const e=t.audioInput.findIndex((e=>o.label.includes(e.label)));e&&t.audioInput.unshift(t.audioInput.splice(e,1)[0])}if(i){const e=t.audioOutput.findIndex((e=>i.label.includes(e.label)));e&&t.audioOutput.unshift(t.audioOutput.splice(e,1)[0])}return t}();this.setState(e)}catch{}}constructor(){super(),this.updateMediaDevices();try{Me().addEventListener("devicechange",(()=>{this.updateMediaDevices()}))}catch{}je.addListener((()=>{this.updateMediaDevices()}))}getInitialState(){return{videoInput:[],audioInput:[],audioOutput:[]}}}const Le=new Fe,$e=(new Ze.Z((()=>{var e,t;return(null===(e=Le.state)||void 0===e||null===(e=e.audioInput)||void 0===e||null===(t=e.filter)||void 0===t?void 0:t.call(e,(e=>null==e?void 0:e.label)))??[]}),{debugName:"AudioInputDevicesStore"}),Le);class Oe{constructor(e){this._audioContext=void 0,this._mediaStream=void 0,this.recorder=void 0,this.onDataReceived=void 0,this.onStop=void 0,this.startController=void 0,this.recorder=new Ne,this.onDataReceived=e.onDataReceived,this.onStop=e.onStop}set audioContext(e){this._audioContext&&this._audioContext.close(),this._audioContext=e}set mediaStream(e){if(this._mediaStream)for(const t of this._mediaStream.getTracks())t.stop();this._mediaStream=e}get audioContext(){return this._audioContext}get mediaStream(){return this._mediaStream}async start(){if(void 0===this.startController||this.startController.signal.aborted){this.startController=new AbortController;const e=this.startController.signal;this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=function(e){const t=window.AudioContext||window.webkitAudioContext||!1;var n;if(t)return new t({...void 0!==e&&(null===(n=navigator)||void 0===n||null===(n=n.mediaDevices)||void 0===n?void 0:n.getSupportedConstraints().sampleRate)&&{sampleRate:e}});throw new Error("Browser does not support Web Audio API (AudioContext is not available).")}(16e3)),this.audioContext.resume();const t=Me();if(this.mediaStream=await t.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:16e3,channelCount:1}}),e.aborted)return void(this.mediaStream=void 0);{const e=new Map;for(const t of this.mediaStream.getTracks())e.set(t.id,t),t.addEventListener("ended",(()=>{e.delete(t.id),e.size||(je.checkPermissions(),$e.updateMediaDevices(),this.stop())}))}await this.recorder.record(this.audioContext,this.mediaStream,this.onDataReceived),e.aborted&&this.recorder.disconnectMediaResources()}}stop(){var e;void 0===this.startController||this.startController.signal.aborted||(this.startController.abort(),null===(e=this.audioContext)||void 0===e||e.suspend(),this.recorder.disconnectMediaResources(),this.mediaStream=void 0,this.onStop&&this.onStop())}destroy(){this.stop(),this.audioContext=void 0}}class Ne{constructor(){this._audioWorkletNode=void 0,this._source=void 0}async record(e,t,o){if(this.disconnectMediaResources(),e.audioWorklet)try{const i=new Ie(e.sampleRate,16e3),s=e.createMediaStreamSource(t);await e.audioWorklet.addModule(new URL(n(40366),n.b));const r=new AudioWorkletNode(e,"pcm-processor");r.port.onmessage=e=>{if(e.data){const t=e.data,n=i.downsample(t);o(n)}},s.connect(r),this._audioWorkletNode=r,this._source=s}catch{console.info("unable to create worklet")}}disconnectMediaResources(){this._source&&(this._source.disconnect(),this._source=void 0),this._audioWorkletNode&&(this._audioWorkletNode.disconnect(),this._audioWorkletNode=void 0)}}var ze=n(68688);const Ve=/([\?\!\.])\s/;class We{constructor(e,t){this.id=void 0,this.text=void 0,this.isCompleteReceived=void 0,this.transcriptions=void 0,this.id=e,this.isCompleteReceived=!!t,this.transcriptions=new Map}updateText(){let e;for(const t of this.transcriptions.values()){if("pending"===t.status)break;"complete"===t.status&&(e=t.text)}this.text=e}setTranscription(e,t){this.transcriptions.set(e,t),this.updateText()}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getText(){return this.text}isSettled(){return this.isCompleteReceived&&[...this.transcriptions.values()].every((e=>"pending"!==e.status))}}class Ke{constructor(e){this.blockStore=void 0,this.segments=void 0,this.isSettled=void 0;const{blockStore:t}=e;this.blockStore=t,this.segments=new Map,this.isSettled=!1}setSegment(e,t){this.segments.set(e,t)}getSegments(){return this.segments.values()}getBlockStore(){return this.blockStore}deleteSegment(e){this.segments.delete(e)}getIsSettled(){return this.isSettled}setIsSettled(e){this.isSettled=e}}class Ue{constructor(e){this.id=void 0,this.env=void 0,this.isCompleteReceived=void 0,this.segments=void 0,this.blockSegmentManager=void 0,this.blockSegmentManagers=void 0,this.latestSettledText=void 0;const{id:t,env:n,blockStore:o}=e,i=new Ke({blockStore:o});this.id=t,this.env=n,this.isCompleteReceived=!1,this.segments=new Map,this.blockSegmentManagers=new Set([i]),this.blockSegmentManager=i,this.latestSettledText=""}getEnvironment(){return this.env}getOrCreateSegment(e){const t=this.segments.get(e);if(t)return t;{const t=new We(e);return this.segments.set(e,t),this.blockSegmentManager.setSegment(e,t),t}}getBlockSegmentManager(){return this.blockSegmentManager}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getFullText(e){return[...e.values()].map((e=>e.getText())).filter((e=>!!e)).join(" ").trim()}isSettled(){return this.isCompleteReceived&&[...this.segments.values()].every((e=>e.isSettled()))}setLatestSettledText(e){this.latestSettledText=e.trim()}getIndexOfBlockSegmentManagers(e){return Array.from(this.blockSegmentManagers).indexOf(e)}addToBlockSegmentManagers(e,t){if("number"==typeof t&&t>=0&&t<this.blockSegmentManagers.size){const n=Array.from(this.blockSegmentManagers);n.splice(t,0,e),this.blockSegmentManagers=new Set(n)}else this.blockSegmentManagers.add(e)}writeToBlock(){const e=this.blockSegmentManager.getBlockStore(),t=this.blockSegmentManager.getBlockStore().getParentBlockStore();if(e&&e.isDictatableBlock()&&t){const n=new Map;for(const e of[...this.blockSegmentManager.getSegments()]){if(!e.isSettled())break;n.set(e.getId(),e)}const o=this.getFullText([...n.values()]),i=function(e){const t=e.split(Ve);for(var n=1;n<t.length;n++)"."!==t[n]&&"?"!==t[n]&&"!"!==t[n]||(t[n-1]+=t[n],t[n]="");const o=t.filter((function(e){return void 0!==e&&""!==e})),i=[];let s="";for(const r of o)s.length>=250&&(i.push(s.trim()),s=""),s+=` ${r}`;s.length>0&&(i.push(s.trim()),s="");return i}(this.latestSettledText?[this.latestSettledText,o].join(" "):o);if(i.length>1){const o=i.pop();for(const n of i){const{performResult:o}=Ge({environment:this.env,parentBlockStore:t,sibling:e,actionType:"before"}),i=new Ke({blockStore:o});i.setIsSettled(!0);const s=this.getIndexOfBlockSegmentManagers(this.blockSegmentManager);this.addToBlockSegmentManagers(i,s),He({environment:this.env,block:o,transcriptions:[{text:n,settled:!0}]})}[...n.values()].slice(-1).pop()&&o&&this.setLatestSettledText(o??"");for(const e of[...n.keys()])this.blockSegmentManager.deleteSegment(e)}const s=[];this.latestSettledText&&s.push({text:this.latestSettledText,settled:!0});for(const e of this.blockSegmentManager.getSegments()){const t=e.getText();t&&s.push({text:t,settled:e.isSettled()})}He({environment:this.env,block:this.blockSegmentManager.getBlockStore(),transcriptions:s})}}}function Ge(e){let{environment:t,parentBlockStore:n,sibling:o,actionType:s}=e;return l.createAndCommit({userAction:"transcription.test.create",environment:t,perform:e=>{const c=a.j4({environment:t,type:(null==o?void 0:o.getDictationRoleModel())??i.Ti.text,inMemoryRecordCache:n.inMemoryRecordCache,transaction:e,useCrdt:n.useCrdt()});return"before"===s?r.Vt({parent:n.getContentStore(),insert:Ce.G.createChildStore(n.getContentStore(),c.pointer),before:o,transaction:e}):r.BE({parent:n.getContentStore(),insert:Ce.G.createChildStore(n.getContentStore(),c.pointer),after:o,transaction:e}),c}})}function He(e){let{environment:t,block:n,transcriptions:o}=e;if(n.isDictatableBlock()){const e=[],i=o.filter((e=>!!e.text));for(const[t,n]of i.entries()){const o=t===i.length-1?n.text:`${n.text} `,r=n.settled?(0,s.V3y)(o):(0,s.V3y)(o,[["dut",Date.now(),Re.L]]);e.push(r)}l.createAndCommit({userAction:"transcription.test.create",environment:t,perform:o=>{if(!n)throw new Error("No block store provided.");c.sO({environment:t,editorMode:"default",store:n.getBlockTitleStore(),value:e,transaction:o})}})}}function Xe(e,t,n){var o;if(n&&!n.pathIsDead()&&n.id!==t.id&&(null===(o=(0,ke.Dg)(n))||void 0===o?void 0:o.id)===t.id){const t=n.getParentBlockStore();if(n.isEmptyDictatableBlock()&&[...P.ZP.state.audioSessionBlockWriters.values()].every((e=>e.getBlockSegmentManager().getBlockStore().id!==n.id)))return n;if(t)return Ge({environment:e,parentBlockStore:t,sibling:n,actionType:"after"}).performResult}return Ge({environment:e,parentBlockStore:t}).performResult}class Qe{static getDictationAudioRecorder(e){const{environment:t}=e,n=P.ZP.state.audioRecorder;return n?(n.stop(),n):new Oe({onDataReceived:async e=>{var n;!async function(e){var t;const{base64Audio:n,environment:o}=e;await(null===(t=fe({method:"audioData",request:{base64Audio:n},environment:o}))||void 0===t?void 0:t.response)}({base64Audio:await(n=e,new Promise(((e,t)=>{try{const o=new Blob([n]),i=new FileReader;i.readAsDataURL(o),i.onloadend=()=>{var n;const o=null===(n=i.result)||void 0===n?void 0:n.toString().split(",")[1];o?e(o):t(new Error("No base64Audio"))}}catch(o){t(o)}}))),environment:t})},onStop:()=>{!async function(e){var t;const{environment:n}=e;await(null===(t=fe({method:"audioFinished",request:{},environment:n}))||void 0===t?void 0:t.response)}({environment:t}),et()}})}static get dictationIsActive(){return Boolean(this.startController&&!this.startController.signal.aborted)}static async smartToggleDictation(e){var t;const n=(0,be.np)();return this.dictationIsActive&&(null===(t=P.ZP.state.pageBlock)||void 0===t?void 0:t.id)===(null==n?void 0:n.id)?this.stopDictation():this.startDictation(e)}static async startDictation(e){this.stopDictation();try{this.startController=new AbortController,P.ZP.setState({...P.ZP.state,loading:!0});const t=this.startController.signal,n=e.pageBlock??(0,be.np)();if(!n||!n.isPageBlock()||!(0,ze.d)(ye.Z.getMode(e.environment,n)))throw new Error("Page is not dictatable.");const o=this.getDictationAudioRecorder(e);new tt;try{const{environment:i}=e;if(await o.start(),je.setState(De),t.aborted)throw new Error("start dictation aborted");const s=xe.default.state.stores.slice(-1).pop();P.ZP.setState({...P.ZP.state,audioRecorder:o,enabled:!0,pageBlock:n,block:Xe(i,n,s),environment:i})}catch{o.destroy(),t.aborted||je.checkPermissions()}}catch{this.stopDictation()}finally{P.ZP.setState({...P.ZP.state,loading:!1})}}static stopDictation(){var e;this.startController&&!this.startController.signal.aborted&&(this.startController.abort(),null===(e=P.ZP.state.audioRecorder)||void 0===e||e.destroy(),P.ZP.setState({...P.ZP.state,audioRecorder:void 0,enabled:!1,loading:!1,pageBlock:void 0,block:void 0}))}}async function Je(e){return Qe.smartToggleDictation(e)}async function Ye(e){return Qe.startDictation(e)}function et(){Qe.stopDictation()}Qe.startController=void 0;class tt{constructor(){if(tt.instance)return tt.instance;tt.instance=this,q.on(_,tt.processTranscriptionResult)}static processTranscriptionResult(e){const{audioSessionId:t,segmentId:n,isSegmentComplete:o,isAudioSessionComplete:i}=e,{enabled:s,pageBlock:r,audioSessionBlockWriters:a,environment:c,block:l}=P.ZP.state;if(!a.has(t)&&c&&s){const e=r?Xe(c,r,l):void 0;if(e){const n=new Ue({id:t,env:c,blockStore:e});a.set(t,n),P.ZP.setState({...P.ZP.state,block:e})}else et()}const d=a.get(t);if(d){d.setIsCompleteReceived(i);const t=d.getOrCreateSegment(n);t.setIsCompleteReceived(o),t.setTranscription(e.transcription.id,e.transcription)}for(const p of a.values())p.writeToBlock();for(const p of[...a.values()].filter((e=>e.isSettled()))){var u;a.delete(p.getId()),s&&c&&r&&(null===(u=P.ZP.state.block)||void 0===u?void 0:u.id)===p.getBlockSegmentManager().getBlockStore().id&&P.ZP.setState({...P.ZP.state,block:Xe(c,r,P.ZP.state.block)})}}}tt.instance=void 0;var nt=n(65820),ot=n(33993),it=n(67294),st=n(86628),rt=n(24405),at=n(45238),ct=n(85893);const lt=(0,at.IU)("face",{viewBox:"0 0 20 20",svg:(0,ct.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 15 15",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,ct.jsx)("path",{d:"M8.77466 2.02246L5.01025 11.4435C5.01025 11.4435 5.99019 11.4838 6.82881 11.6749C7.57951 11.8459 8.62557 12.4865 8.62557 12.4865",stroke:"black",strokeWidth:"0.648179",strokeLinecap:"round"}),(0,ct.jsx)("path",{d:"M8.9704 4.39196C8.9704 4.39196 9.58528 3.90572 9.97993 3.59501C10.2343 3.39475 10.5894 3.19083 10.5894 3.19083C10.8652 3.0298 11.3652 2.94621 11.6745 2.94632C12.2696 2.94652 12.6513 3.33565 12.7239 3.43557C12.8661 3.6315 12.9389 3.873 12.9571 4.10479C12.9737 4.31554 12.8745 5.04712 12.8745 5.04712C12.8745 5.04712 12.7274 5.74318 12.2904 5.98257C12.1179 6.0771 11.9543 6.15451 11.7264 6.0893C11.4695 6.01583 11.3918 5.8817 11.3652 5.61587C11.329 5.25283 11.702 4.88311 11.8439 4.81355C12.049 4.71297 12.3311 4.64471 12.5635 4.68158",stroke:"black",strokeWidth:"0.648179",strokeLinecap:"round"}),(0,ct.jsx)("rect",{x:"11.5803",y:"4.85645",width:"1.02211",height:"0.961297",fill:"black"}),(0,ct.jsx)("path",{d:"M1.72852 5.00713C1.72852 5.00713 2.25959 4.43053 2.60067 4.06181C2.82051 3.82416 3.19459 3.51165 3.19459 3.51165C3.44181 3.30938 3.82839 3.13054 4.18863 3.05383C4.77061 2.92991 5.33916 3.29305 5.42648 3.38036C5.59769 3.55157 5.65546 3.67794 5.70981 3.90401C5.75923 4.10955 5.81071 4.29091 5.79534 4.51669C5.76496 4.9627 5.77322 5.26207 5.37915 5.56699C5.22354 5.6874 5.07417 5.78947 4.83881 5.76079C4.57362 5.72848 4.47584 5.60819 4.40794 5.34981C4.31521 4.99695 4.62567 4.57334 4.75491 4.48239C4.94175 4.35091 5.07245 4.25411 5.3077 4.25411",stroke:"black",strokeWidth:"0.648179",strokeLinecap:"round"}),(0,ct.jsx)("rect",{x:"4.67651",y:"4.39648",width:"0.889315",height:"1.12208",fill:"black"})]})});var dt=n(51454),ut=n(1898),pt=n(18574);function ht(e){let t=[];return e.nodeType===Node.TEXT_NODE?t.push(e):e.childNodes.forEach((e=>{t=t.concat(ht(e))})),t}const ft=25;function mt(e){let{scrollerStore:t,children:n}=e;const o=(0,st.VK)((()=>P.CX.state),[]),i=(0,st.VK)((()=>t.state.scrollTop),[t]),[s,r]=(0,it.useState)(),[a,c]=(0,it.useState)(),l=(0,pt.Si)(t),d=(0,pt.nA)(t),u=null==l?void 0:l.scrollerEl(),p=null==u?void 0:u.querySelector(".notion-page-content"),h=null==p?void 0:p.querySelector(`[data-block-id="${o}"]`);(0,it.useEffect)((()=>{if(p){let e;const t=new MutationObserver((t=>{(0,ut.$K)(e)&&cancelAnimationFrame(e),e=requestAnimationFrame((()=>r(Date.now())))}));return t.observe(p,{subtree:!0,characterData:!0,childList:!0}),()=>{t.disconnect(),(0,ut.$K)(e)&&cancelAnimationFrame(e)}}}),[p]),(0,it.useEffect)((()=>{if(u){let e;const t=new ResizeObserver((()=>{(0,ut.$K)(e)&&cancelAnimationFrame(e),e=requestAnimationFrame((()=>r(Date.now())))}));return t.observe(u),()=>{t.disconnect(),(0,ut.$K)(e)&&cancelAnimationFrame(e)}}}),[u]),(0,it.useLayoutEffect)((()=>{if(h&&u){const e=document.createRange(),t=h.querySelector('[data-content-editable-leaf="true"]')??h,n=ht(t),o=u.getBoundingClientRect();if(n.length>0){const t=n[n.length-1];e.selectNodeContents(t),e.collapse(!1);const s=e.getBoundingClientRect(),r=s.top+i-o.top+(s.height-ft)/2,a=s.right-o.left+5;c({top:r,left:a})}else{const e=t.getBoundingClientRect(),n=window.getComputedStyle(t),s=parseInt(n.lineHeight,10),r=parseInt(n.paddingTop,10),a=isNaN(s)?e.height:s,l=isNaN(r)?0:r,d=e.top+l+i-o.top+(a-ft)/2,u=e.left-o.left;c({top:d,left:u})}}else c(void 0)}),[h,u,s,i]);const f=(0,ut.$K)(a);return(0,it.useEffect)((()=>{if(d&&f)switch(d){case"Page":return P.ZP.setState({...P.ZP.state,blockRenderedInPage:!0}),()=>{P.ZP.setState({...P.ZP.state,blockRenderedInPage:!1})};case"PeekView":return P.ZP.setState({...P.ZP.state,blockRenderedInPeekView:!0}),()=>{P.ZP.setState({...P.ZP.state,blockRenderedInPeekView:!1})}}}),[d,f]),a?(0,ct.jsx)(ot.E.div,{initial:{top:null==a?void 0:a.top,left:null==a?void 0:a.left},animate:{top:null==a?void 0:a.top,left:null==a?void 0:a.left},transition:{duration:.2},style:{display:"block",position:"absolute",zIndex:dt.lB-1},children:n}):null}function gt(e){let{scrollerStore:t}=e;const n=(0,st.VK)((()=>P.ZP.state.enabled),[]);return(0,ct.jsx)(nt.M,{children:n?(0,ct.jsxs)(mt,{scrollerStore:t,children:[(0,ct.jsx)(vt,{size:25}),(0,ct.jsx)(St,{})]}):null})}function vt(e){let{size:t}=e;const n=(0,rt.yK)((e=>({faceIcon:{width:20,height:20,pointerEvents:"none",color:e.regularTextColor}})),[]),o=(0,it.useMemo)((()=>lt({...n.faceIcon})),[n.faceIcon]);return(0,ct.jsx)(ot.E.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0,transition:{type:"spring",duration:.5,bounce:.25}},style:{top:0,left:0,position:"absolute",height:t,width:t,background:"white",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.14)",borderRadius:15,zIndex:2,display:"flex",justifyContent:"center",alignItems:"center"},children:o})}function St(){const e=(0,st.VK)((()=>P.ZP.getState().audioRecorder),[]),[t,n]=(0,it.useState)(0),o=(0,rt.yK)((e=>({verticalLineColor:{background:e.regularTextColor}})),[]);return(0,it.useEffect)((()=>{if(e){const{audioContext:t,mediaStream:o}=e;if(o&&t){const e=t.createMediaStreamSource(o),i=t.createAnalyser();i.fftSize=256,e.connect(i);const s=new AbortController,r=new Uint8Array(i.frequencyBinCount),a=s.signal,c=()=>{if(a.aborted)return;i.getByteFrequencyData(r);var e;const t=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.9,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1.5;return e<t?o:e>n?i:o+(e-t)/(n-t)*(i-o)}((e=r).length>0?e.reduce(((e,t)=>e+t),0)/e.length:0);n(t),l=requestAnimationFrame(c)};let l=requestAnimationFrame(c);return()=>{s.abort(),cancelAnimationFrame(l),e.disconnect()}}}}),[e]),(0,ct.jsx)(ot.E.div,{initial:{opacity:0,x:-10,rotate:0},animate:{opacity:1,x:0,rotate:10},exit:{opacity:0,x:-10,rotate:0},style:{position:"absolute",left:3,top:0,height:25,width:1,zIndex:1,scaleY:t,scaleX:t,...o.verticalLineColor},transition:{opacity:{duration:.3},x:{type:"tween"}}})}var wt=n(480);const bt=(0,at.IU)("stop",{viewBox:"0 0 20 20",svg:(0,ct.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 19 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,ct.jsx)("rect",{y:"0.793945",width:"18.8027",height:"18.8027",rx:"9.40137",fill:"#37352F"}),(0,ct.jsx)("rect",{x:"5.91028",y:"6.7041",width:"6.98255",height:"6.98255",rx:"0.783447",fill:"white"})]})});var kt=n(82361),yt=n(11066);function Ct(){return(0,st.VK)((()=>P.ZP.getState().enabled&&!P.ZP.getState().loading),[])?(0,ct.jsx)(xt,{}):null}function xt(){const e=(0,wt.O7)(),t=(0,rt.Fg)(),n=(0,st.VK)((()=>{const e=P.P7.state;if(e)return!e.isDictatableBlock()||e.pathIsDead()}),[]),o=(0,st.VK)((()=>!P.w7.state),[]);(0,it.useEffect)((()=>{(0,ut.$K)(n)&&n&&et()}),[n]),(0,it.useEffect)((()=>{if(o){const e=setTimeout((()=>{et()}),250);return()=>{clearTimeout(e)}}}),[o]);const i=(0,it.useCallback)((()=>{et()}),[]),s=(0,kt.r)({rightEdgeDistance:16,isInPeekRenderer:!1,environment:e,overrides:e=>({width:"max-content",height:36,background:e.whiteButtonBackground})}),{roundedButtonStyle:r}=(0,rt.yK)((()=>({roundedButtonStyle:{position:"absolute",bottom:16,left:"50%",transform:"translateX(-50%)",cursor:"pointer",display:"flex",alignItems:"center",padding:"0 8px 0 6px"}})),[]),a=(0,rt.yK)((e=>({icon:{color:e.regularIconColor}})),[]),c=(0,it.useMemo)((()=>bt({width:25,height:25,...a.icon})),[a.icon]);return(0,ct.jsxs)(yt.Z,{className:"notion-dictation-button",style:{...s,...r,gap:"6px",zIndex:dt.Wd+1},hoveredStyle:{background:t.whiteButtonHoveredBackground},pressedStyle:{background:t.whiteButtonPressedBackground},onClick:i,children:[c,(0,ct.jsx)(Rt,{})]})}function Rt(){const e=(0,st.VK)((()=>P.ZP.getState().audioRecorder),[]),t=(0,it.useRef)(null);return(0,it.useEffect)((()=>{if(e){const{mediaStream:n,audioContext:o}=e;if(n&&o){const e=o.createMediaStreamSource(n),i=o.createAnalyser();i.fftSize=256;const s=o.createBiquadFilter();s.type="lowshelf",s.frequency.setValueAtTime(1500,o.currentTime),s.gain.setValueAtTime(-30,o.currentTime),e.connect(s),s.connect(i);const r=new AbortController,a=new Uint8Array(i.frequencyBinCount),c=r.signal,l=()=>{if(c.aborted)return;i.getByteFrequencyData(a);const e=t.current;if(e){const t=window.devicePixelRatio||1,n=e.getBoundingClientRect();e.width=n.width*t,e.height=n.height*t;const o=e.getContext("2d");o.scale(t,t);const i=4;e.width=70*i,e.height=30*i;const s=e.width,r=e.height,c=1*i;let l;o.clearRect(0,0,s,r);const d=2*i;let u=0;for(let e=0;e<a.length;e++){const t=.1*d*Math.random();if(l=Math.max(a[e],d+t)/1.5,o.fillStyle="rgb(128,128,128)",u+c<=s&&o.fillRect(u,r/2-l/2,c,l),u+=c+1*i,u>=s)break}}d=requestAnimationFrame(l)};let d=requestAnimationFrame(l);return()=>{r.abort(),cancelAnimationFrame(d),e.disconnect(),s.disconnect()}}}}),[e]),e?(0,ct.jsx)("canvas",{ref:t,style:{width:"70px",height:"30px"}}):(0,ct.jsx)("div",{style:{fontSize:8},children:"No audio recorder available"})}},40366:(e,t,n)=>{e.exports=n.p+"dbc10b469ee58d20.js"},65820:(e,t,n)=>{n.d(t,{M:()=>v});var o=n(67294),i=n(58868);function s(){const e=(0,o.useRef)(!1);return(0,i.L)((()=>(e.current=!0,()=>{e.current=!1})),[]),e}var r=n(2074);var a=n(240),c=n(96681);class l extends o.Component{getSnapshotBeforeUpdate(e){const t=this.props.childRef.current;if(t&&e.isPresent&&!this.props.isPresent){const e=this.props.sizeRef.current;e.height=t.offsetHeight||0,e.width=t.offsetWidth||0,e.top=t.offsetTop,e.left=t.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function d({children:e,isPresent:t}){const n=(0,o.useId)(),i=(0,o.useRef)(null),s=(0,o.useRef)({width:0,height:0,top:0,left:0});return(0,o.useInsertionEffect)((()=>{const{width:e,height:o,top:r,left:a}=s.current;if(t||!i.current||!e||!o)return;i.current.dataset.motionPopId=n;const c=document.createElement("style");return document.head.appendChild(c),c.sheet&&c.sheet.insertRule(`\n          [data-motion-pop-id="${n}"] {\n            position: absolute !important;\n            width: ${e}px !important;\n            height: ${o}px !important;\n            top: ${r}px !important;\n            left: ${a}px !important;\n          }\n        `),()=>{document.head.removeChild(c)}}),[t]),o.createElement(l,{isPresent:t,childRef:i,sizeRef:s},o.cloneElement(e,{ref:i}))}const u=({children:e,initial:t,isPresent:n,onExitComplete:i,custom:s,presenceAffectsLayout:r,mode:l})=>{const u=(0,c.h)(p),h=(0,o.useId)(),f=(0,o.useMemo)((()=>({id:h,initial:t,isPresent:n,custom:s,onExitComplete:e=>{u.set(e,!0);for(const t of u.values())if(!t)return;i&&i()},register:e=>(u.set(e,!1),()=>u.delete(e))})),r?void 0:[n]);return(0,o.useMemo)((()=>{u.forEach(((e,t)=>u.set(t,!1)))}),[n]),o.useEffect((()=>{!n&&!u.size&&i&&i()}),[n]),"popLayout"===l&&(e=o.createElement(d,{isPresent:n},e)),o.createElement(a.O.Provider,{value:f},e)};function p(){return new Map}var h=n(25364),f=n(65411),m=n(45487);const g=e=>e.key||"";const v=({children:e,custom:t,initial:n=!0,onExitComplete:a,exitBeforeEnter:c,presenceAffectsLayout:l=!0,mode:d="sync"})=>{(0,m.k)(!c,"Replace exitBeforeEnter with mode='wait'");const p=(0,o.useContext)(h.p).forceRender||function(){const e=s(),[t,n]=(0,o.useState)(0),i=(0,o.useCallback)((()=>{e.current&&n(t+1)}),[t]);return[(0,o.useCallback)((()=>r.Wi.postRender(i)),[i]),t]}()[0],v=s(),S=function(e){const t=[];return o.Children.forEach(e,(e=>{(0,o.isValidElement)(e)&&t.push(e)})),t}(e);let w=S;const b=(0,o.useRef)(new Map).current,k=(0,o.useRef)(w),y=(0,o.useRef)(new Map).current,C=(0,o.useRef)(!0);if((0,i.L)((()=>{C.current=!1,function(e,t){e.forEach((e=>{const n=g(e);t.set(n,e)}))}(S,y),k.current=w})),(0,f.z)((()=>{C.current=!0,y.clear(),b.clear()})),C.current)return o.createElement(o.Fragment,null,w.map((e=>o.createElement(u,{key:g(e),isPresent:!0,initial:!!n&&void 0,presenceAffectsLayout:l,mode:d},e))));w=[...w];const x=k.current.map(g),R=S.map(g),I=x.length;for(let o=0;o<I;o++){const e=x[o];-1!==R.indexOf(e)||b.has(e)||b.set(e,void 0)}return"wait"===d&&b.size&&(w=[]),b.forEach(((e,n)=>{if(-1!==R.indexOf(n))return;const i=y.get(n);if(!i)return;const s=x.indexOf(n);let r=e;if(!r){const e=()=>{b.delete(n);const e=Array.from(y.keys()).filter((e=>!R.includes(e)));if(e.forEach((e=>y.delete(e))),k.current=S.filter((t=>{const o=g(t);return o===n||e.includes(o)})),!b.size){if(!1===v.current)return;p(),a&&a()}};r=o.createElement(u,{key:g(i),isPresent:!1,onExitComplete:e,custom:t,presenceAffectsLayout:l,mode:d},i),b.set(n,r)}w.splice(s,0,r)})),w=w.map((e=>{const t=e.key;return b.has(t)?e:o.createElement(u,{key:g(e),isPresent:!0,presenceAffectsLayout:l,mode:d},e)})),o.createElement(o.Fragment,null,b.size?w:w.map((e=>(0,o.cloneElement)(e))))}}}]);